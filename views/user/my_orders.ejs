<%- include('../layouts/user/header.ejs') %>

<style>
  .orders-container {
    display: flex;
    margin: auto; 
  }
  
  .order-card {
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 10px;
    background: #fff;
  }
  
  .order-header {
    display: flex;
    font-weight: bold;
  }
  
  .order-details {
    display: flex;
    margin-top: 15px;
    gap: 20px;
  }

  .rate-review-btn, .cancel-order {
    padding: 6px 12px;
    border: none;
    color: #ffffff;
    cursor: pointer;
  }

  .cancel-order {
    background-color: #dc3545;
  }

  .no-orders {
    text-align: center;
    margin-top: 20px;
  }
</style>




<div class="container mt-5">
  <div class="card">
    <div class="card-header">
      <h5 class="mb-0">Your Orders</h5>
    </div>
      <div class="table-responsive">
        <table>
          <thead class="thead-dark">
            <tr>
              <th>Order ID</th>
              <th>Shipping Address</th>
              <th>Items</th>
              <th>Total Price</th>
              <th>Payment Method</th>
              <th>Order Status</th>
              <th>Order Date</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <% if (Array.isArray(my_orders) && my_orders.length) { %>
              <% my_orders.forEach(order => { %>
                <tr>
                <td>#<%= order._id.toString().slice(-4) %></td>
                  <td>
                    <strong>Name:</strong> <%= order.shipping_address.name %><br>
                    <strong>Mobile:</strong> <%= order.shipping_address.mobile %><br>
                    <strong>Address:</strong> <%= order.shipping_address.address %><br>
                    <strong>City:</strong> <%= order.shipping_address.city %><br>
                    <strong>State:</strong> <%= order.shipping_address.state %><br>
                    <strong>Postal Code:</strong> <%= order.shipping_address.postal_code %><br>
                    <strong>Landmark:</strong> <%= order.shipping_address.landmark || "N/A" %>
                  </td>
                  <td>
                    <% order.items.forEach(item => { %>
                      <div class="d-flex align-items-center mb-2">
                        <img src="<%= item.product.product_card_image %>" alt="Product Image" style="width: 50px; height: 50px; border-radius: 4px; margin-right: 10px;">
                        <div>
                          <strong>Product:</strong> <%= item.product.name %><br>
                          <strong>Brand:</strong> <%= item.product.brand.brandName %><br>
                          <strong>Category:</strong> <%= item.product.category.name %><br>
                          <strong>Volume:</strong> <%= item.product.variants.volume %>ml<br>
                          <strong>Price:</strong> ₹<%= item.product.variants.price %><br>
                          <strong>Quantity:</strong> <%= item.quantity %>
                        </div>
                      </div>
                      <hr>
                    <% }) %>
                  </td>
                  <td class="text-right">₹<%= order.total %></td>
                  <td>
                    <%= order.payment_method %>
                    <% if(my_orders.payment_method === 'Credit Card') { %>
                      <i class="fas fa-credit-card ml-2"></i>
                    <% } else if(my_orders.payment_method === 'COD') { %>
                      <i class="fas fa-money-bill-wave ml-2"></i>
                    <% } %>
                  </td>
                  <td>
                    <span class="text"><%= order.order_status %></span>
                  </td>
                  
                  
                  <td><%= new Date(order.createdAt).toLocaleDateString() %></td>
                  <td>
                    <% if(order.order_status === 'Cancelled') { %>
                    <button class="btn btn-sm " disabled="true">Cancelled</button>
                      <% } else { %>
                    <button class="btn btn-sm cancel-order" data-order-id="<%= order._id %>">Cancel</button>
                    <% } %>
                  </td>
                </tr>
              <% }) %>
            <% } else { %>
              <tr>
                <td colspan="9" class="text-center">No orders found.</td>
                <a href="/user_profile"><button class="btn btn-md p-10 ml-10 mt-10 mb-10">back to profile</button></a>
              <a href="/home"><button class="btn btn-md p-10 ml-10 mt-10 mb-10">Go to Home</button></a>
              </tr>
              
            <% } %>
          </tbody>
        </table>
      </div>
  </div>
</div>

<%- include('../layouts/user/footer.ejs') %>

<script>
    document.querySelectorAll('.cancel-order').forEach(button => {
      button.addEventListener('click', async () => {
        const orderId = button.getAttribute('data-order-id');

        Swal.fire({
          title: 'Are you sure?',
          text: "Do you want to cancel this order? This action cannot be undone!",
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#3085d6',
          cancelButtonColor: '#d33',
          confirmButtonText: 'Yes, cancel it!',
          cancelButtonText: 'No, keep it',
        }).then(async (result) => {
          if (result.isConfirmed) {
           
            const response = await fetch(`/cancel_order/${orderId}`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' }
            });
  
            const data = await response.json();
            if (data.success) {
              Swal.fire(
                'Cancelled!',
                'Your order has been cancelled.',
                'success'
              ).then(() => {
                location.reload();
              });
            } else {
              Swal.fire(
                'Failed!',
                'Failed to cancel the order. Please try again.',
                'error'
              );
            }
          }
        });
      });
    });
  </script>
  